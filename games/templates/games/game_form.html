{% extends 'games/base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block extra_css %}
<style>
    .drag-drop-area {
        border: 2px dashed #ccc;
        border-radius: 4px;
        padding: 20px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .drag-drop-area:hover {
        border-color: #0d6efd;
        background-color: #e9ecef;
    }
    .drag-drop-area.dragover {
        border-color: #0d6efd;
        background-color: #e9ecef;
    }
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
    }
    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -5px;
        margin-left: -5px;
    }
    .form-group {
        flex: 0 0 auto;
        width: auto;
        padding-right: 5px;
        padding-left: 5px;
    }
    .ai-fill-button {
        margin-left: 10px;
    }
    .loading-spinner {
        display: none;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">
                    {% if form.instance.pk %}
                    {% trans "Edit Game" %}
                    {% else %}
                    {% trans "Add New Game" %}
                    {% endif %}
                </h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.title|as_crispy_field }}
                        </div>
                        <div class="form-group">
                            <!-- <button type="button" id="ai-fill-button" class="btn btn-outline-primary ai-fill-button">
                                <i class="bi bi-robot"></i> {% trans "AI Fill" %}
                            </button> -->
                            <div class="spinner-border text-primary loading-spinner" role="status">
                                <span class="visually-hidden">{% trans "Loading..." %}</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.platform|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.genre|as_crispy_field }}
                        </div>
                        <div class="form-group">
                            {{ form.release_year|as_crispy_field }}
                        </div>
                        <div class="form-group">
                            {{ form.number_of_players|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.description|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.lan_playable|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.image|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.notes|as_crispy_field }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            {% if form.instance.pk %}
                            <i class="bi bi-check-lg"></i> {% trans "Save Changes" %}
                            {% else %}
                            <i class="bi bi-plus-lg"></i> {% trans "Add Game" %}
                            {% endif %}
                        </button>
                        <a href="{% url 'game-list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> {% trans "Cancel" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.querySelector('input[type="file"]');
    const dragDropArea = document.createElement('div');
    dragDropArea.className = 'drag-drop-area';
    dragDropArea.innerHTML = `
        <i class="bi bi-cloud-upload fs-1"></i>
        <p class="mt-2">{% trans "Drag and drop an image here or click to select" %}</p>
    `;
    
    // Insert the drag-drop area before the file input
    imageInput.parentNode.insertBefore(dragDropArea, imageInput);
    imageInput.style.display = 'none';

    // Handle click on drag-drop area
    dragDropArea.addEventListener('click', () => imageInput.click());

    // Handle drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dragDropArea.classList.add('dragover');
    }

    function unhighlight(e) {
        dragDropArea.classList.remove('dragover');
    }

    // Handle file drop
    dragDropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        imageInput.files = files;
        handleFiles(files);
    }

    // Handle file selection
    imageInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Remove existing preview if any
                    const existingPreview = dragDropArea.querySelector('.image-preview');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    
                    // Create and add new preview
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'image-preview';
                    dragDropArea.appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
        }
    }

    // Show existing image if editing
    {% if form.instance.image %}
    const existingImage = document.createElement('img');
    existingImage.src = '{{ form.instance.image.url }}';
    existingImage.className = 'image-preview';
    dragDropArea.appendChild(existingImage);
    {% endif %}

    // AI Fill functionality
    const aiFillButton = document.getElementById('ai-fill-button');
    const loadingSpinner = document.querySelector('.loading-spinner');
    const titleInput = document.querySelector('#id_title');

    aiFillButton.addEventListener('click', async function() {
        const title = titleInput.value.trim();
        if (!title) {
            alert('{% trans "Please enter a game title first" %}');
            return;
        }

        try {
            // Show loading spinner
            aiFillButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';

            // Make API request
            const response = await fetch('{% url "ai-game-info" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `title=${encodeURIComponent(title)}`
            });

            if (!response.ok) {
                const errorData = await response.json();
                if (errorData.redirect) {
                    window.location.href = errorData.redirect;
                    return;
                }
                throw new Error(errorData.error || '{% trans "Failed to get AI response" %}');
            }

            const data = await response.json();

            // Fill form fields
            document.querySelector('#id_platform').value = data.platform;
            document.querySelector('#id_genre').value = data.genre;
            document.querySelector('#id_release_year').value = data.release_year;
            document.querySelector('#id_number_of_players').value = data.number_of_players;
            document.querySelector('#id_description').value = data.description;
            document.querySelector('#id_lan_playable').checked = data.lan_playable;
            document.querySelector('#id_notes').value = data.notes;

        } catch (error) {
            alert(`{% trans "Error" %}: ${error.message}`);
        } finally {
            // Hide loading spinner
            aiFillButton.disabled = false;
            loadingSpinner.style.display = 'none';
        }
    });
});
</script>
{% endblock %} 